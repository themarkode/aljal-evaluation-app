rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user has Al-Jal company email domain
    // Adjust the domain to match your company's email domain
    function isCompanyEmployee() {
      return isAuthenticated() && 
             request.auth.token.email != null &&
             (request.auth.token.email.matches('.*@aljal\\.com\\.kw$') ||
              request.auth.token.email.matches('.*@aljal\\.com$') ||
              request.auth.token.email_verified == true);
    }
    
    // Helper function to check if user is admin (via custom claims)
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    // Evaluations collection - requires authentication
    match /evaluations/{evaluationId} {
      // Allow read if user is authenticated
      allow read: if isAuthenticated();
      
      // Allow create if user is authenticated
      allow create: if isAuthenticated();
      
      // Allow update if user is authenticated and either:
      // - They created the document (createdBy matches their uid)
      // - They are an admin
      // - The document doesn't have a createdBy field (legacy data)
      allow update: if isAuthenticated() && (
        !resource.data.keys().hasAny(['createdBy']) ||
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
      
      // Allow delete only for admins or document creator
      allow delete: if isAuthenticated() && (
        !resource.data.keys().hasAny(['createdBy']) ||
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Users collection - for storing user profiles
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can create/update their own profile
      allow create, update: if isAuthenticated() && request.auth.uid == userId;
      
      // Only admins can delete user profiles
      allow delete: if isAdmin();
    }
    
    // Settings collection - admin only
    match /settings/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
